@model MenuViewModel
@section Styles{
    <link href="~/assets/plugins/uppy/uppy.bundle.css" rel="stylesheet" />
}

<div class="d-flex flex-column-fluid">
    <!--begin::Container-->
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <!--begin::Card-->
                <div class="card card-custom gutter-b example example-compact">
                    <div class="card-header">
                        <h3 class="card-title">Menu Info</h3>
                    </div>
                    <form class="form" enctype="multipart/form-data" asp-action="Save" asp-controller="Menu" method="post"
                          data-ajax="true"
                          data-ajax-method="POST"
                          data-ajax-begin="onBegin"
                          data-ajax-success="onSuccess"
                          data-ajax-failure="onFailure" style="position:relative;">
                        <input type="hidden" asp-for="Id" />
                        <input type="hidden" asp-for="ImageLP" />
                        <input type="hidden" asp-for="ImagePL" />
                        <input type="hidden" asp-for="ImageMB" />
                        <div class="card-body">
                            <div class="form-group row">
                                <div class="col-lg-6 col-12">
                                    <label asp-for="ImageTitle"></label>
                                    <input asp-for="ImageTitle" class="form-control" />
                                    <span asp-validation-for="ImageTitle" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="form-group row align-items-center">
                                <div class="col-lg-6">
                                    <div class="card card-custom card-stretch">
                                        <div class="card-header">
                                            <div class="card-title">
                                                <h3 class="card-label">Add new laptop size title image</h3>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="uppy" id="menu_title_lp">
                                                <div class="uppy-dashboard"></div>
                                                <div class="uppy-progress"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                @if (Model.Id != Guid.Empty)
                                {
                                    <div class="col-lg-6 mb-3 mb-lg-0">
                                        <label asp-for="ImageLP"></label>
                                        <img class="symbol" style="width:100%;height:auto;" src="/@Model.ImageLP" />
                                    </div>
                                }
                            </div>
                            <div class="form-group row align-items-center">
                                <div class="col-lg-6">
                                    <div class="card card-custom card-stretch">
                                        <div class="card-header">
                                            <div class="card-title">
                                                <h3 class="card-label">Add new IPad size title image</h3>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="uppy" id="menu_title_pl">
                                                <div class="uppy-dashboard"></div>
                                                <div class="uppy-progress"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                @if (Model.Id != Guid.Empty)
                                {
                                    <div class="col-lg-6 mb-3 mb-lg-0">
                                        <label asp-for="ImagePL"></label>
                                        <img class="symbol" style="width:100%;height:auto;" src="/@Model.ImagePL" />
                                    </div>
                                }
                            </div>
                            <div class="form-group row align-items-center">
                                <div class="col-lg-6">
                                    <div class="card card-custom card-stretch">
                                        <div class="card-header">
                                            <div class="card-title">
                                                <h3 class="card-label">Add new mobile size title image</h3>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="uppy" id="menu_title_mb">
                                                <div class="uppy-dashboard"></div>
                                                <div class="uppy-progress"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                @if (Model.Id != Guid.Empty)
                                {
                                    <div class="col-lg-6 mb-3 mb-lg-0">
                                        <label asp-for="ImageMB"></label>
                                        <img class="symbol" style="width:100%;height:auto;" src="/@Model.ImageMB" />
                                    </div>
                                }
                            </div>
                            <div class="form-group row">
                                <div class="col-12">
                                    <label asp-for="FlavorsTitle"></label>
                                    <input asp-for="FlavorsTitle" class="form-control" />
                                    <span asp-validation-for="FlavorsTitle" class="text-danger"></span>
                                </div>
                                <div class="col-12">
                                    <label asp-for="FlavorsText"></label>
                                    <textarea asp-for="FlavorsText" rows="10" class="form-control" />@Model.FlavorsText</textarea>
                                    <span asp-validation-for="FlavorsText" class="text-danger"></span>
                                </div>
                            </div>
                            
                            <div class="form-group row">
                                <div class=" col-12">
                                    <label asp-for="FruitHeadTitle"></label>
                                    <input asp-for="FruitHeadTitle" class="form-control" />
                                    <span asp-validation-for="FruitHeadTitle" class="text-danger"></span>
                                </div>
                                <div class=" col-12">
                                    <label asp-for="FruitHeadText"></label>
                                    <textarea asp-for="FruitHeadText" rows="10" class="form-control" />@Model.FruitHeadText</textarea>
                                    <span asp-validation-for="FruitHeadText" class="text-danger"></span>
                                </div>
                            </div>
                            
                        </div>
                        <div class="card-footer">
                            <div class="row">
                                <div class="col-lg-6">
                                    <button type="submit" onclick="submitOnClicked(this)" class="btn btn-secondary">@UI.Submit</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <script src="~/assets/plugins/uppy/uppy.bundle.js"></script>
    <script>
            function onBegin() {
                util.loading(true, "form");
           }
          function onSuccess(data) {
              util.loading(false, "form");
              window.location.reload();
           }
             function onFailure() {
                 util.loading(false, "form");
            }
        function submitOnClicked(e) {
            //$('#fileMaxError').addClass('showFileError');
            @*var tot = Math.ceil((totalSize / 1024) / 1000);
            if (tot > parseInt(@Html.Raw(Formats.FileSize))) {
                $('#fileMaxError').removeClass('showFileError');
                throw new Error('File size exception');
            }*@
            $(".files").remove();
            $(".filetype").remove();
            $(".filename").remove();
            $(".fieldname").remove();
            console.log(uppyDashboard.state.files);
            console.log(files);
            if (files.length != 0) {
                for (var file in uppyDashboard.state.files) {
                    $("form").append(" <input class='files' type='hidden' value='" + files[uppyDashboard.state.files[file].id] + "'  name='Base64String' />");
                    $("form").append(" <input class='filetype' type='hidden'value='" + uppyDashboard.state.files[file].data.type + "' name='ContentType' />");
                    $("form").append(" <input class='filename' type='hidden' value='" + uppyDashboard.state.files[file].data.name + "'  name='FileName' />");
                    $("form").append(" <input class='fieldname' type='hidden' value='@(nameof(MenuViewModel.ImageLP))'  name='FieldName' />");
                }

                for (var file in uppyDashboardPL.state.files) {
                    $("form").append(" <input class='files' type='hidden' value='" + files[uppyDashboardPL.state.files[file].id] + "'  name='Base64String' />");
                    $("form").append(" <input class='filetype' type='hidden'value='" + uppyDashboardPL.state.files[file].data.type + "' name='ContentType' />");
                    $("form").append(" <input class='filename' type='hidden' value='" + uppyDashboardPL.state.files[file].data.name + "'  name='FileName' />");
                    $("form").append(" <input class='fieldname' type='hidden' value='@(nameof(MenuViewModel.ImagePL))'  name='FieldName' />");
                }

                for (var file in uppyDashboardMB.state.files) {
                    $("form").append(" <input class='files' type='hidden' value='" + files[uppyDashboardMB.state.files[file].id] + "'  name='Base64String' />");
                    $("form").append(" <input class='filetype' type='hidden'value='" + uppyDashboardMB.state.files[file].data.type + "' name='ContentType' />");
                    $("form").append(" <input class='filename' type='hidden' value='" + uppyDashboardMB.state.files[file].data.name + "'  name='FileName' />");
                    $("form").append(" <input class='fieldname' type='hidden' value='@(nameof(MenuViewModel.ImageMB))'  name='FieldName' />");
                }
            }
        }
    </script>
    <script>
        var files = {};

            //lp
            var totalSize = 0;
            var uppyDashboard;

            //pl
            var totalSizePL = 0;
            var uppyDashboardPL;

            //mb
            var totalSizeMB = 0;
            var uppyDashboardMB;

            var KTUppy = function () {
                const Tus = Uppy.Tus;
                const ProgressBar = Uppy.ProgressBar;
                const StatusBar = Uppy.StatusBar;
                const FileInput = Uppy.FileInput;
                const Informer = Uppy.Informer;
                const ImageEditor = Uppy.ImageEditor;
                // to get uppy companions working, please refer to the official documentation here: https://uppy.io/docs/companion/
                const Dashboard = Uppy.Dashboard;
                const Dropbox = Uppy.Dropbox;
                const GoogleDrive = Uppy.GoogleDrive;
                const Instagram = Uppy.Instagram;
                const Webcam = Uppy.Webcam;

                var options = {
                    proudlyDisplayPoweredByUppy: false,
                    inline: true,
                    replaceTargetContent: true,
                    showProgressDetails: true,
                    hideUploadButton: true,
                    hideRetryButton: true,
                    hidePauseResumeButton: true,
                    showProgressDetails: true,
                    browserBackButtonClose: true,
                    plugins: ['ImageEditor'],
                }

                var initUppy1 = function () {
                     uppyDashboard = Uppy.Core({
                        id: 'uppy',
                        autoProceed: false,
                        allowMultipleUploads: false,
                        restrictions: {
                            allowedFileTypes: ['image/*'],
                            maxFileSize: @(5 * 1024 * 1024),
                            maxTotalFileSize: @(5 * 1 * 1024 * 1024),
                            maxNumberOfFiles: 1,
                            minNumberOfFiles: 1
                        }
                     });
                    options.target = '#menu_title_lp';
                    uppyDashboard.use(Dashboard, options);
                 @*   uppyDashboard.use(Webcam, {
                        target: Dashboard,
                        modes: [
                            //'video-audio',
                            //'video-only',
                            //'audio-only',
                            'picture'
                        ],
                    });*@

                    uppyDashboard.use(ImageEditor, {
                        id: 'ImageEditor',
                        target: Dashboard,
                        quality: 0.8,
                        cropperOptions: {
                            viewMode: 1,
                            background: false,
                            autoCropArea: 1,
                            responsive: true
                        },
                        actions: {
                            revert: true,
                            rotate: true,
                            flip: true,
                            zoomIn: true,
                            zoomOut: true,
                            cropSquare: true,
                            cropWidescreen: true,
                            cropWidescreenVertical: true
                        }
                    })
                    uppyDashboard.on('file-added', (file) => {
                        totalSize += file.data.size;
                        let reader = new FileReader();
                        reader.readAsDataURL(file.data);

                        reader.onloadend = function () {
                            let base64data = reader.result;
                            files[file.id] = base64data;
                        };
                    })
                    uppyDashboard.on('file-removed', (file, reason) => {
                        totalSize -= file.data.size;
                        delete files[file.id];
                    })
                    uppyDashboard.on('file-editor:complete', (updatedFile) => {
                        totalSize += updatedFile.data.size;
                        let reader = new FileReader();
                        reader.readAsDataURL(updatedFile.data);
                        reader.onloadend = function () {
                            let base64data = reader.result;
                            files[updatedFile.id] = base64data;
                        };
                    })
                }
                 var initUppy2 = function () {
                     uppyDashboardPL = Uppy.Core({
                        id: 'uppy',
                        autoProceed: false,
                        allowMultipleUploads: false,
                        restrictions: {
                            allowedFileTypes: ['image/*'],
                            maxFileSize: @(5 * 1024 * 1024),
                            maxTotalFileSize: @(5 * 1 * 1024 * 1024),
                            maxNumberOfFiles: 1,
                            minNumberOfFiles: 1
                        }
                     });
                    options.target = '#menu_title_pl';
                     uppyDashboardPL.use(Dashboard, options);
                 @*   uppyDashboard.use(Webcam, {
                        target: Dashboard,
                        modes: [
                            //'video-audio',
                            //'video-only',
                            //'audio-only',
                            'picture'
                        ],
                    });*@

                     uppyDashboardPL.use(ImageEditor, {
                        id: 'ImageEditor',
                        target: Dashboard,
                        quality: 0.8,
                        cropperOptions: {
                            viewMode: 1,
                            background: false,
                            autoCropArea: 1,
                            responsive: true
                        },
                        actions: {
                            revert: true,
                            rotate: true,
                            flip: true,
                            zoomIn: true,
                            zoomOut: true,
                            cropSquare: true,
                            cropWidescreen: true,
                            cropWidescreenVertical: true
                        }
                    })
                     uppyDashboardPL.on('file-added', (file) => {
                         totalSizePL += file.data.size;
                        let reader = new FileReader();
                        reader.readAsDataURL(file.data);

                        reader.onloadend = function () {
                            let base64data = reader.result;
                            files[file.id] = base64data;
                        };
                    })
                     uppyDashboardPL.on('file-removed', (file, reason) => {
                         totalSizePL -= file.data.size;
                        delete files[file.id];
                    })
                     uppyDashboardPL.on('file-editor:complete', (updatedFile) => {
                         totalSizePL += updatedFile.data.size;
                        let reader = new FileReader();
                        reader.readAsDataURL(updatedFile.data);
                        reader.onloadend = function () {
                            let base64data = reader.result;
                            files[updatedFile.id] = base64data;
                        };
                    })
                }
                var initUppy3 = function () {
                    uppyDashboardMB = Uppy.Core({
                        id: 'uppy',
                        autoProceed: false,
                        allowMultipleUploads: false,
                        restrictions: {
                            allowedFileTypes: ['image/*'],
                            maxFileSize: @(5 * 1024 * 1024),
                            maxTotalFileSize: @(5 * 1 * 1024 * 1024),
                            maxNumberOfFiles: 1,
                            minNumberOfFiles: 1
                        }
                     });
                    options.target = '#menu_title_mb';
                    uppyDashboardMB.use(Dashboard, options);
                 @*   uppyDashboard.use(Webcam, {
                        target: Dashboard,
                        modes: [
                            //'video-audio',
                            //'video-only',
                            //'audio-only',
                            'picture'
                        ],
                    });*@

                    uppyDashboardMB.use(ImageEditor, {
                        id: 'ImageEditor',
                        target: Dashboard,
                        quality: 0.8,
                        cropperOptions: {
                            viewMode: 1,
                            background: false,
                            autoCropArea: 1,
                            responsive: true
                        },
                        actions: {
                            revert: true,
                            rotate: true,
                            flip: true,
                            zoomIn: true,
                            zoomOut: true,
                            cropSquare: true,
                            cropWidescreen: true,
                            cropWidescreenVertical: true
                        }
                    })
                    uppyDashboardMB.on('file-added', (file) => {
                        totalSizeMB += file.data.size;
                        let reader = new FileReader();
                        reader.readAsDataURL(file.data);

                        reader.onloadend = function () {
                            let base64data = reader.result;
                            files[file.id] = base64data;
                        };
                    })
                    uppyDashboardMB.on('file-removed', (file, reason) => {
                        totalSizeMB -= file.data.size;
                        delete files[file.id];
                    })
                    uppyDashboardMB.on('file-editor:complete', (updatedFile) => {
                        totalSizeMB += updatedFile.data.size;
                        let reader = new FileReader();
                        reader.readAsDataURL(updatedFile.data);
                        reader.onloadend = function () {
                            let base64data = reader.result;
                            files[updatedFile.id] = base64data;
                        };
                    })
                }
                return {
                    // public functions
                    init: function () {
                        initUppy1();
                        initUppy2();
                        initUppy3();
                    }
                };
        }();



            jQuery(document).ready(function () {
                KTUtil.ready(function () {
                    KTUppy.init();
                });
            });
    </script>
}
